define(["storageApi","ccConstants","ccRestClient","pubsub","CCi18n","knockout","jquery"],function(e,t,i,n,s,o,r){"use strict";function a(){if(a.singleInstance)throw new Error("Cannot instantiate more than one CCPreviewBar, use getInstance()");var f=this;this.isMinifyJs=o.observable(),this.cssPath="/shared/css/oj-preview-bar.css",this.templateUrl="/shared/templates",this.templateName="preview-bar.template",this.selectedSite=o.observable(),this.debugMenuButtonText=o.observable("Debug Tools"),this.minifyJsText=o.observable("Minify JavaScript"),this.siteSelectionLabel=o.observable("Site Selection"),this.ojLoaded=r.Deferred(),this.sites=null,this.currentSiteId=null;var h,d=!1;if(this.isDisableMinifyJs=o.computed(function(){return i.previewMode&&!f.isMinifyJs()}),this.storeMinifyJs=function(t,i){"rawValue"!==i.option&&"value"!==i.option||void 0===i.previousValue||e.getInstance().setSessionItem(u,f.isMinifyJs())},this.initDebugMenu=function(){if(i.previewMode){var t=e.getInstance().getSessionItem(u);"true"===t||t===!0||null===t?this.isMinifyJs(!0):this.isMinifyJs(!1),h=this.isMinifyJs()}},this.initSiteSelection=function(e){if(i.previewMode){var o=e.data.global.multisite;f.sites=o,f.validateSiteSelection={Init:function(){},getHint:function(){},validate:function(e){var t=o.filter(function(t){return e[0]===t.id});if(t.length>0)return!0;throw new Error(s.t("ns.common:resources.siteSelectionNoMatchesError"))}};var a=i.getStoredValue(t.LOCAL_STORAGE_SITE_ID);if(a){var c=f.getURLParameter(window.location.search,t.URL_SITE_PARAM),u=o.filter(function(e){return c===e.id});c&&""!=c?a!==c&&u.length>0?(i.setStoredValue(t.LOCAL_STORAGE_SITE_ID,c),f.selectedSite(c),f.currentSiteId=c):(f.selectedSite(a),f.currentSiteId=a):(f.selectedSite(a),f.currentSiteId=a,f.refreshPageWithNewSite(a))}else{var l=o.filter(function(e){return e.defaultSite});l.length>0&&(f.selectedSite(l[0].id),f.currentSiteId=l[0].id)}r.Topic(n.topicNames.PAGE_LAYOUT_LOADED).unsubscribe(f.initSiteSelection)}},this.clearMinJsFlag=function(){e.getInstance().removeSessionItem(u)},this.maybeRefreshPage=function(e){"/payment"!=e&&"/confirmation/"!=e.substring(0,14)&&null!==h&&h!=f.isMinifyJs()&&this.refreshPage(e)},this.refreshPage=function(e){if(i.previewMode){var t=window.location.origin+("/"===e.charAt(0)?e:"/"+e);window.location.assign(t)}},this.focusSwitch=function(e){e.originalEvent&&("click"===e.originalEvent.type&&e.originalEvent.pageX<=0&&e.originalEvent.pageY<=0||"keydown"===e.originalEvent.type)&&(r(l+" + div.oj-switch-container").find("div.oj-switch-thumb").focus(),d=!0)},this.attachEventHandlers=function(){r(l+" + div.oj-switch-container").find("div.oj-switch-thumb").on("keyup"+c,function(e){return e.keyCode===t.KEY_CODE_ENTER&&d?(d=!1,!1):(d=!1,!0)}).on("keydown"+c,function(e){return d=!1,e.keyCode!==t.KEY_CODE_ENTER&&e.keyCode!==t.KEY_CODE_SPACE||(e.stopPropagation(),e.preventDefault()),!0});var e;r("#oj-combobox-input-previewBarSiteSelection").on("focus",function(t){e!==this&&(e=this,setTimeout(function(){e.select()},50))})},this.getURLParameter=function(e,t){if(e&&""!==e){var i,n=(e.split("?")[0],[]),s=e.split("?")[1];if(""!==s){n=s.split("&");for(var o=n.length-1;o>=0;o-=1)if(i=n[o].split("=")[0],i===t)return n[o].split("=")[1]}}return null},this.removeParamFromURL=function(e,t){if(t.indexOf("?")===-1)return t;var i,n=t.split("?")[0],s=[],o=t.split("?")[1];if(""!==o){s=o.split("&");for(var r=s.length-1;r>=0;r-=1)i=s[r].split("=")[0],i===e&&s.splice(r,1);s.length>0&&(n=n+"?"+s.join("&"))}return n},this.changeSiteCallBack=function(e,n){if("value"===n.option){var s=i.getStoredValue(t.LOCAL_STORAGE_SITE_ID),o=n.value[0];o!==s&&(i.setStoredValue(t.LOCAL_STORAGE_SITE_ID,o),f.refreshPageWithNewSite(o))}},this.refreshPageWithNewSite=function(e){var i=f.removeParamFromURL(t.URL_SITE_PARAM,window.location.search);i+=i.indexOf("?")===-1?"?":"&",i+=t.URL_SITE_PARAM+"="+encodeURIComponent(e);for(var n=null,s=null,o=0;o<f.sites.length;o++)f.sites[o].id===e&&(n=f.sites[o]),f.sites[o].id===f.currentSiteId&&(s=f.sites[o]);var r=n.productionURL.substring(n.productionURL.indexOf("/")),a=s.productionURL.substring(s.productionURL.indexOf("/"));f.refreshPage.call(f,window.location.pathname.replace(a,r)+i)},i.previewMode){r.Topic(n.topicNames.HISTORY_PUSH_STATE).subscribe(this.maybeRefreshPage.bind(this)),window.history&&window.history.pushState&&window.addEventListener("popstate",function(e){f.maybeRefreshPage.call(f,window.location.pathname+window.location.search)}),r.Topic(n.topicNames.LOCALE_READY).subscribe(function(e){f.debugMenuButtonText(s.t("ns.common:resources.debugMenuButtonText")),f.minifyJsText(s.t("ns.common:resources.minifyJsText")),f.siteSelectionLabel(s.t("ns.common:resources.siteSelectionLabel"))}),i.registerLogoutAdminUpdateCallback(this.clearMinJsFlag),this.initDebugMenu(),r.Topic(n.topicNames.PAGE_LAYOUT_LOADED).subscribe(this.initSiteSelection);var p=["ojs/ojcore","ojs/ojknockout","ojs/ojswitch","ojs/ojbutton","ojs/ojmenu","ojs/ojselectcombobox"];require(p,function(){f.ojLoaded.resolve()})}}var c=".previewBar",u="min_js_preview",l="#previewMinifySwitch";return a.getInstance=function(){return a.singleInstance||(a.singleInstance=new a),a.singleInstance},a});
//# sourceMappingURL=cc-preview-bar.js.map