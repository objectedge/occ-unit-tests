define("swmRestClientConstructor",["jquery","ccRestClient","ccLogger","storageApi","pageLayout/site"],function(e,t,s,r,i){"use strict";function c(e,s){var i=this;i.isInitialized=!1,i.usingCCAuthentication=!1,i.isSynced=!1,i.unauthorizedCount=0,i.cors="withCredentials"in new XMLHttpRequest,i.corsFrameReady=!1,i.ccsyncInProgress=!1,i.ccsyncBlockedCallQue={items:[]},i.refreshTimeoutID=null,i.siteid="",i.ccsiteid="",i.apiuserid="",i.apiuserauth="";try{r.getInstance().removeItem("social.ccsyncprofileid"),r.getInstance().removeItem("social.ccsyncapiuserid")}catch(e){}i.ccrestapi=t,i.tenantid="",i.swmhost="",i.isPreview=!1,i.currentRequestId=0,i.commonSuccessCallback=e,i.commonErrorCallback=s,i.doRefresh=function(){if(i.usingCCAuthentication){var e=function(){},s=function(e){};i.refresh(e,s),t.storeRequestWasMade=!0}},i.stackedPostMessages={items:[]},i.setCorsFrameReady=function(){if(i.corsFrameReady=!0,i.stackedPostMessages&&i.stackedPostMessages.items.length>0){for(var e=0;e<i.stackedPostMessages.items.length;e++)i.proxyFrame.postMessage(i.stackedPostMessages.items[e].msgObj,i.swmhost);i.stackedPostMessages={items:[]}}}}return c.GET="GET",c.POST="POST",c.JSON="json",c.REQUEST_JSON_CONTENT_TYPE="application/json",c.REQUEST_FORM_URL_ENCODED="application/x-www-form-urlencoded",c.SWM_CCSYNC_ENDPOINT="/swm/rs/v1/users/cc",c.SWM_REFRESH_ENDPOINT="/swm/rs/v1/users/refresh",c.AUTH_HEADER_NAME="Authorization",c.CC_TENANTID_HEADER_NAME="X-CCTenantId",c.CC_SITEID_HEADER_NAME="X-CCSiteId",c.CC_ISPREVIEW_HEADER_NAME="X-CCIsPreview",c.ACCEPT_LANGUAGE_HEADER_NAME="Accept-Language",c.SWM_ACCESS_TOKEN="access_token",c.AUTH_HEADER_PREFIX="Bearer ",c.JWT_BEARER_GRANT_TYPE="urn:ietf:params:oauth:grant-type:jwt-bearer",c.TOKEN_REFRESH_TIMEOUT=5e3,c.IFRAME_ELEMENT="iframe",c.ZERO="0",c.IFRAME_STYLE="width: 0; height: 0; border: none;",c.IFRAME_NAME="swm_iframe",c.ID_ATTRIBUTE="id",c.NAME_ATTRIBUTE="name",c.WIDTH_ATTRIBUTE="width",c.HEIGHT_ATTRIBUTE="height",c.BORDER_ATTRIBUTE="border",c.STYLE_ATTRIBUTE="style",c.SRC_ATTRIBUTE="src",c.MAX_INT=4294967295,c.prototype.setSWMHost=function(e){this.swmhost=e},c.prototype.init=function(e,t,s){var r=this;if(r.tenantid=e,r.isPreview=1==t?"true":"false",r.locale=s,r.ccsiteid=i.getInstance().siteInfo.id,!r.cors&&!r.isInitialized){r.crossDomainUrl=r.swmhost+"/swm/pm/?tenantId="+e+"&isPreview="+r.isPreview,r.eventHandlerMap={},r.eventHandlerMap.initializedSWMFrame={success:r.setCorsFrameReady,error:r.setCorsFrameReady},r.initXDomainMessageListener();var c=r.createCrossDomainIFrame();null!=c&&(r.proxyFrame=c.contentWindow)}r.isInitialized=!0},c.prototype.createCrossDomainIFrame=function(){var e=this,t=c.IFRAME_NAME,s=document.createElement(c.IFRAME_ELEMENT);s.setAttribute(c.ID_ATTRIBUTE,t),s.setAttribute(c.NAME_ATTRIBUTE,t),s.setAttribute(c.WIDTH_ATTRIBUTE,c.ZERO),s.setAttribute(c.HEIGHT_ATTRIBUTE,c.ZERO),s.setAttribute(c.BORDER_ATTRIBUTE,c.ZERO),s.setAttribute(c.STYLE_ATTRIBUTE,c.IFRAME_STYLE),s.setAttribute(c.SRC_ATTRIBUTE,e.crossDomainUrl);var r=null;try{document.body.appendChild(s),window.frames[t].name=t,r=document.getElementById(t)}catch(e){}return r},c.prototype.initXDomainMessageListener=function(){var e=this;window.addEventListener("message",function(t){var s=t.origin;if(s===e.swmhost){var r;r="string"==typeof t.data?JSON.parse(t.data):t.data;var i=r.id,c=r.success,n=r.payload,o=e.eventHandlerMap[i];o&&(c?o.success(n):o.error(JSON.stringify(n)))}},!1)},c.prototype.proxyRequest=function(e,t,s,r,i,n){var o=this;o.currentRequestId>=c.MAX_INT?o.currentRequestId=0:o.currentRequestId++;var a=o.currentRequestId;o.eventHandlerMap[a]={success:r,error:i};var u=t.replace("{siteid}",o.siteid);u=o.swmhost+o.insertParamsIntoUri(u,n),u.indexOf(c.SWM_REFRESH_ENDPOINT)==-1&&u.indexOf(c.SWM_CCSYNC_ENDPOINT)==-1&&(null==o.refreshTimeoutID?o.refreshTimeoutID=setTimeout(o.doRefresh,c.TOKEN_REFRESH_TIMEOUT):(clearTimeout(o.refreshTimeoutID),o.refreshTimeoutID=setTimeout(o.doRefresh,c.TOKEN_REFRESH_TIMEOUT)));var E=0===t.indexOf(c.SWM_CCSYNC_ENDPOINT),l=(E?c.REQUEST_FORM_URL_ENCODED:c.REQUEST_JSON_CONTENT_TYPE,s?E?s:JSON.stringify(s):""),d={};d.id=a,d.pMethod=e,d.pUrl=u,d.pData=l,d.pIsPreview=o.isPreview,d.pTenantId=o.tenantid,d.pCCSiteId=o.ccsiteid,d.pLocale=o.locale,d.pApiuserauth=o.apiuserauth,d.pAssertion=o.ccrestapi.tokenSecret,o.corsFrameReady?o.proxyFrame.postMessage(JSON.stringify(d),o.swmhost):o.stackedPostMessages.items.push({msgObj:JSON.stringify(d)})},c.prototype.syncCCUser=function(e,t){var s=this,i=function(t){s.isSynced=!0,s.siteid=t.siteId,s.apiuserid=t.userId,s.apiuserauth=t.access_token;try{r.getInstance().setItem("social.ccsyncprofileid",s.ccrestapi.profileId),r.getInstance().setItem("social.ccsyncapiuserid",t.userId)}catch(e){}e&&e(t)},n=function(e){s.isSynced=!1,null!=s.refreshTimeoutID&&clearTimeout(s.refreshTimeoutID),t&&t(e)};this.cors?this.corsRequest(c.POST,c.SWM_CCSYNC_ENDPOINT+"/{ccprofileid}","grant_type="+encodeURIComponent(c.JWT_BEARER_GRANT_TYPE)+"&assertion="+encodeURIComponent(s.ccrestapi.tokenSecret),i,n,{ccprofileid:s.ccrestapi.profileId}):this.proxyRequest(c.POST,c.SWM_CCSYNC_ENDPOINT+"/{ccprofileid}","grant_type="+encodeURIComponent(c.JWT_BEARER_GRANT_TYPE)+"&assertion="+encodeURIComponent(s.ccrestapi.tokenSecret),i,n,{ccprofileid:s.ccrestapi.profileId})},c.prototype.refresh=function(e,t){var s=this,r=function(t){s.isSynced=!0,s.apiuserauth=t.access_token,e&&e(t)},i=function(e){};s.apiuserauth?s.cors?s.corsRequest(c.POST,c.SWM_REFRESH_ENDPOINT,{},r,i):s.proxyRequest(c.POST,c.SWM_REFRESH_ENDPOINT,{},r,i):i()},c.prototype.clear=function(){var e=this;e.usingCCAuthentication=!1,e.isSynced=!1,e.siteid="",e.apiuserid="",e.apiuserauth="";try{r.getInstance().removeItem("social.ccsyncprofileid"),r.getInstance().removeItem("social.ccsyncapiuserid")}catch(e){}},c.prototype.request=function(e,t,i,c,n,o){var a=this,u=c,E=n;if(""==a.swmhost||!a.isInitialized)return void s.warn("rest client not initialized properly");null!=a.ccrestapi.profileId&&null!=a.ccrestapi.tokenSecret&&(a.usingCCAuthentication=!0);var l=r.getInstance().getItem("social.ccsyncprofileid"),d=r.getInstance().getItem("social.ccsyncapiuserid");if(l&&a.ccrestapi.profileId!==l||d&&a.apiuserid!==d){a.clear();var T='{"o:errorCode":"401.99"}';return void a.commonErrorCallback(T)}if(a.apiuserid===d&&a.ccrestapi.profileId===l||(a.isSynced=!1),a.usingCCAuthentication&&!a.isSynced){var p=function(s){a.ccsyncInProgress=!1,a.cors?a.corsRequest(e,t,i,u,E,o):a.proxyRequest(e,t,i,u,E,o),a.ccsyncBlockedCallQueExecution()},I=function(e){a.ccsyncInProgress=!1,null!=a.refreshTimeoutID&&clearTimeout(a.refreshTimeoutID),E&&E(e)};a.ccsyncInProgress?a.ccsyncBlockedCallQue.items.push({pMethod:e,pUrl:t,pData:i,pSuccessCallback:c,pErrorCallback:n,pJSONParams:o}):(a.ccsyncInProgress=!0,a.syncCCUser(p,I))}else a.cors?this.corsRequest(e,t,i,c,n,o):this.proxyRequest(e,t,i,c,n,o)},c.prototype.ccsyncBlockedCallQueExecution=function(){var e=this;if(e.ccsyncBlockedCallQue.items.length>0){for(var t=0;t<e.ccsyncBlockedCallQue.items.length;t++)e.cors?e.corsRequest(e.ccsyncBlockedCallQue.items[t].pMethod,e.ccsyncBlockedCallQue.items[t].pUrl,e.ccsyncBlockedCallQue.items[t].pData,e.ccsyncBlockedCallQue.items[t].pSuccessCallback,e.ccsyncBlockedCallQue.items[t].reqErrorCB,e.ccsyncBlockedCallQue.items[t].pJSONParams):e.proxyRequest(e.ccsyncBlockedCallQue.items[t].pMethod,e.ccsyncBlockedCallQue.items[t].pUrl,e.ccsyncBlockedCallQue.items[t].pData,e.ccsyncBlockedCallQue.items[t].pSuccessCallback,e.ccsyncBlockedCallQue.items[t].reqErrorCB,e.ccsyncBlockedCallQue.items[t].pJSONParams);e.ccsyncBlockedCallQue={items:[]}}},c.prototype.corsRequest=function(t,s,r,i,n,o){var a=this,u=t,E=s.replace("{siteid}",a.siteid);E=a.swmhost+a.insertParamsIntoUri(E,o),E.indexOf(c.SWM_REFRESH_ENDPOINT)==-1&&E.indexOf(c.SWM_CCSYNC_ENDPOINT)==-1&&(null==a.refreshTimeoutID?a.refreshTimeoutID=setTimeout(a.doRefresh,c.TOKEN_REFRESH_TIMEOUT):(clearTimeout(a.refreshTimeoutID),a.refreshTimeoutID=setTimeout(a.doRefresh,c.TOKEN_REFRESH_TIMEOUT)));var l=function(e){s.indexOf(c.SWM_CCSYNC_ENDPOINT)==-1&&(a.unauthorizedCount=0);var t=function(e,t){a.commonSuccessCallback(e,t),i(e,t)};t(e.data,e.textStatus)},d=function(e){var u=function(e,t,s){a.commonErrorCallback(e,t,s),n(e,t,s)};if(a.usingCCAuthentication)try{var E=JSON.parse(e.jqXHR.responseText);a.unauthorizedCount<=1&&401===E.status&&s.indexOf(c.SWM_CCSYNC_ENDPOINT)==-1?(a.isSynced=!1,a.unauthorizedCount++,a.request(t,s,r,i,n,o)):u(e.jqXHR.responseText,e.jqXHR.status,e.errorThrown)}catch(e){}else u(e.jqXHR.responseText,e.jqXHR.status,e.errorThrown)};u===c.GET&&(E=a.fixIECaching(E));var T=0===s.indexOf(c.SWM_CCSYNC_ENDPOINT),p=T?c.REQUEST_FORM_URL_ENCODED:c.REQUEST_JSON_CONTENT_TYPE,I=r?T?r:JSON.stringify(r):"",_={};_={dataType:c.JSON,contentType:p,type:u,url:E,data:I,processData:!1,success:function(e,t,s){l({data:e,textStatus:t,jqXHR:s})},error:function(e,t,s){d({jqXHR:e,textStatus:t,errorThrown:s})}};var R={};R[c.CC_ISPREVIEW_HEADER_NAME]=a.isPreview,R[c.ACCEPT_LANGUAGE_HEADER_NAME]=a.locale,T?(R[c.CC_TENANTID_HEADER_NAME]=a.tenantid,R[c.CC_SITEID_HEADER_NAME]=a.ccsiteid):a.apiuserauth&&a.apiuserauth.length>0&&(R[c.AUTH_HEADER_NAME]=c.AUTH_HEADER_PREFIX+a.apiuserauth),_.headers=R,e.ajax(_)},c.prototype.insertParamsIntoUri=function(e,t){var s=e;for(var r in t)t.hasOwnProperty(r)&&(s=s.replace("{"+r+"}",encodeURIComponent(t[r])));return s},c.prototype.fixIECaching=function(e){return e&&"Microsoft Internet Explorer"==navigator.appName&&(e+=(e.indexOf("?")!==-1?"&":"?")+"__ie__fix__="+(new Date).getTime()),e},c.getTimestamp=function(e){var t=new Date/1e3,s=parseInt(e,10),r=t+s;return parseInt(+r,10)},c});
//# sourceMappingURL=swm-rest-client-1.0.js.map